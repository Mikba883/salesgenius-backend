<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Assistente AI in tempo reale per venditori B2B">
    
    <title>SalesGenius - AI Sales Assistant</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --secondary: #764ba2;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-main: #f9fafb;
            --bg-card: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: var(--bg-card);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1000px;
            width: 100%;
            padding: 40px;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        h1 {
            color: var(--primary);
            font-size: 32px;
            font-weight: 700;
        }

        .subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: var(--bg-main);
            border-radius: 12px;
            border: 2px solid var(--border);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
            transition: all 0.3s;
        }

        .status-dot.connected {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .status-text {
            font-weight: 500;
            color: var(--text-primary);
        }

        .warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid var(--warning);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: start;
            gap: 15px;
        }

        .warning-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .warning-text {
            color: #92400e;
            font-size: 14px;
            line-height: 1.6;
        }

        .warning-text strong {
            display: block;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        button {
            padding: 18px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        #startBtn {
            background: var(--success);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        #startBtn:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        #startBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        #stopBtn {
            background: var(--danger);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        #stopBtn:hover:not(:disabled) {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        #stopBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
        }

        .section-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .transcript-box, .suggestions-box {
            background: var(--bg-main);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            min-height: 180px;
            max-height: 350px;
            overflow-y: auto;
        }

        .transcript-box::-webkit-scrollbar,
        .suggestions-box::-webkit-scrollbar {
            width: 8px;
        }

        .transcript-box::-webkit-scrollbar-track,
        .suggestions-box::-webkit-scrollbar-track {
            background: transparent;
        }

        .transcript-box::-webkit-scrollbar-thumb,
        .suggestions-box::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .transcript-item {
            padding: 15px;
            margin-bottom: 10px;
            background: var(--bg-card);
            border-radius: 10px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            animation: slideIn 0.3s ease-out;
        }

        .transcript-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .transcript-text {
            color: var(--text-primary);
            line-height: 1.6;
        }

        .suggestion-item {
            padding: 18px;
            margin-bottom: 12px;
            background: var(--bg-card);
            border-radius: 10px;
            border-left: 4px solid var(--success);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            animation: slideIn 0.3s ease-out;
            transition: all 0.3s;
        }

        .suggestion-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .suggestion-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .suggestion-category {
            font-size: 11px;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .suggestion-badge {
            font-size: 10px;
            padding: 3px 8px;
            background: var(--success);
            color: white;
            border-radius: 4px;
            font-weight: 600;
        }

        .suggestion-text {
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 15px;
        }

        .empty-state {
            color: var(--text-secondary);
            text-align: center;
            padding: 50px 20px;
            font-style: italic;
            font-size: 14px;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--border);
            text-align: center;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--bg-main);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid var(--border);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 25px;
            }

            h1 {
                font-size: 24px;
            }

            .controls {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üéØ</div>
            <div>
                <h1>SalesGenius</h1>
                <p class="subtitle">AI Sales Assistant - Test Audio in Tempo Reale</p>
            </div>
        </div>

        <div class="warning">
            <span class="warning-icon">‚ö†Ô∏è</span>
            <div class="warning-text">
                <strong>Come usare l'applicazione:</strong>
                1. Apri la tua chiamata (Google Meet, Zoom web, Teams web) in un'altra tab del browser<br>
                2. Torna qui e clicca "‚ñ∂Ô∏è Avvia Registrazione"<br>
                3. Nel popup, seleziona la TAB della chiamata e ‚úÖ spunta "Condividi audio della tab"<br>
                4. Parla normalmente - vedrai trascrizioni e suggerimenti AI in tempo reale!<br>
                <br>
                <strong>Nota:</strong> Funziona solo con chiamate nel BROWSER (non app desktop Zoom/Teams)
            </div>
        </div>

        <div class="status">
            <div class="status-dot" id="statusDot"></div>
            <span class="status-text" id="statusText">üî¥ Non connesso al backend</span>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="transcriptCount">0</div>
                <div class="stat-label">Trascrizioni</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="suggestionCount">0</div>
                <div class="stat-label">Suggerimenti</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="duration">00:00</div>
                <div class="stat-label">Durata</div>
            </div>
        </div>

        <div class="controls">
            <button id="startBtn">
                <span>‚ñ∂Ô∏è</span>
                <span>Avvia Registrazione</span>
            </button>
            <button id="stopBtn" disabled>
                <span>‚èπÔ∏è</span>
                <span>Ferma</span>
            </button>
        </div>

        <div class="section">
            <div class="section-title">
                <div class="section-icon">üìù</div>
                <span>Trascrizione Real-Time</span>
            </div>
            <div class="transcript-box" id="transcriptBox">
                <div class="empty-state">
                    <div class="empty-state-icon">üé§</div>
                    Premi "Avvia Registrazione" e inizia a parlare nella tua chiamata...
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">
                <div class="section-icon">üí°</div>
                <span>Suggerimenti AI</span>
            </div>
            <div class="suggestions-box" id="suggestionsBox">
                <div class="empty-state">
                    <div class="empty-state-icon">ü§ñ</div>
                    I suggerimenti AI appariranno qui automaticamente durante la conversazione...
                </div>
            </div>
        </div>

        <div class="footer">
            Backend: <a href="https://salesgenius-backend.onrender.com/health" target="_blank" rel="noopener">salesgenius-backend.onrender.com</a>
            <br>
            Powered by Deepgram + OpenAI
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURAZIONE
        // ==========================================
        const WS_URL = 'wss://salesgenius-backend.onrender.com';
        
        // ==========================================
        // ELEMENTI DOM
        // ==========================================
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const transcriptBox = document.getElementById('transcriptBox');
        const suggestionsBox = document.getElementById('suggestionsBox');
        const transcriptCount = document.getElementById('transcriptCount');
        const suggestionCount = document.getElementById('suggestionCount');
        const durationEl = document.getElementById('duration');

        // ==========================================
        // VARIABILI GLOBALI
        // ==========================================
        let ws = null;
        let mediaRecorder = null;
        let audioContext = null;
        let isRecording = false;
        let transcripts = 0;
        let suggestions = 0;
        let startTime = null;
        let durationInterval = null;

        // ==========================================
        // WEBSOCKET MANAGEMENT
        // ==========================================
        function connectWebSocket() {
            console.log('üîå Connessione a:', WS_URL);
            
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                console.log('‚úÖ WebSocket connesso');
                console.log('üì° WebSocket readyState:', ws.readyState);
                statusDot.classList.add('connected');
                statusText.textContent = 'üü¢ Connesso al backend - Pronto!';
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('üì® Messaggio ricevuto:', data);

                    if (data.type === 'transcript') {
                        addTranscript(data.text);
                    } else if (data.type === 'suggestion') {
                        addSuggestion(data.text, data.category);
                    } else if (data.type === 'suggestion.start') {
                        console.log('üí° Nuovo suggerimento in arrivo...', data.category);
                    } else if (data.type === 'suggestion.delta') {
                        // Streaming del suggerimento (optional)
                        console.log('üìù Chunk:', data.textChunk);
                    } else if (data.type === 'suggestion.end') {
                        console.log('‚úÖ Suggerimento completato');
                    } else if (data.type === 'error') {
                        console.error('‚ùå Errore dal server:', data.message);
                        alert('Errore: ' + data.message);
                    }
                } catch (err) {
                    console.error('‚ùå Errore parsing messaggio:', err);
                }
            };

            ws.onerror = (error) => {
                console.error('‚ùå WebSocket errore:', error);
                statusText.textContent = 'üî¥ Errore di connessione al backend';
                statusDot.classList.remove('connected');
            };

            ws.onclose = () => {
                console.log('üîå WebSocket chiuso');
                statusText.textContent = 'üî¥ Disconnesso dal backend';
                statusDot.classList.remove('connected');
            };
        }

        // ==========================================
        // AUDIO RECORDING
        // ==========================================
        async function startRecording() {
            try {
                console.log('üé§ Richiedo cattura audio tab...');
                
                // Usa getDisplayMedia per catturare l'audio della TAB
                // NOTA: Dobbiamo richiedere video=true (browser lo richiede), ma useremo solo l'audio
                const stream = await navigator.mediaDevices.getDisplayMedia({ 
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    },
                    video: true // Richiesto dal browser, ma useremo solo l'audio
                });

                // Ferma immediatamente il video (non ci serve)
                const videoTracks = stream.getVideoTracks();
                videoTracks.forEach(track => track.stop());

                console.log('‚úÖ Permessi ottenuti - audio tab catturato');

                // Verifica che ci sia effettivamente un track audio
                const audioTracks = stream.getAudioTracks();
                if (audioTracks.length === 0) {
                    throw new Error('Nessun audio catturato. Assicurati di spuntare "Condividi audio" quando selezioni la tab!');
                }

                console.log('‚úÖ Audio track trovato:', audioTracks[0].label);

                // Crea AudioContext per processare l'audio
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                const source = audioContext.createMediaStreamSource(stream);
                const processor = audioContext.createScriptProcessor(4096, 1, 1);

                source.connect(processor);
                processor.connect(audioContext.destination);

                processor.onaudioprocess = (e) => {
                    if (!isRecording) return;

                    const inputData = e.inputBuffer.getChannelData(0);
                    const pcm16 = float32ToPCM16(inputData);
                    
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(pcm16.buffer);
                        // Log ogni 50 chunks per non sovraccaricare la console
                        if (Math.random() < 0.02) {
                            console.log('üì§ Inviando audio chunk:', pcm16.length, 'bytes');
                        }
                    } else {
                        console.warn('‚ö†Ô∏è WebSocket non pronto. readyState:', ws ? ws.readyState : 'null');
                    }
                };

                // Gestisci la chiusura dello stream (quando l'utente ferma la condivisione)
                stream.getAudioTracks()[0].onended = () => {
                    console.log('‚ö†Ô∏è Condivisione audio terminata');
                    stopRecording();
                    alert('Condivisione audio terminata. Clicca di nuovo su "Avvia Registrazione" per riavviare.');
                };

                mediaRecorder = { stream, processor, source };
                isRecording = true;

                // Avvia timer durata
                startTime = Date.now();
                durationInterval = setInterval(updateDuration, 1000);

                startBtn.disabled = true;
                stopBtn.disabled = false;
                statusText.textContent = 'üéôÔ∏è Registrazione in corso... (cattura audio tab)';

                console.log('‚úÖ Registrazione avviata - sto ascoltando l\'audio della tua chiamata!');

            } catch (err) {
                console.error('‚ùå Errore avvio registrazione:', err);
                
                let errorMsg = 'Errore cattura audio.';
                
                if (err.name === 'NotAllowedError') {
                    errorMsg = 'Permesso negato. Riprova e seleziona la TAB della chiamata, poi spunta "Condividi audio".';
                } else if (err.name === 'NotFoundError') {
                    errorMsg = 'Nessuna tab trovata. Assicurati di avere una chiamata aperta in un\'altra tab del browser.';
                } else if (err.message) {
                    errorMsg = err.message;
                }
                
                alert(errorMsg);
            }
        }

        function stopRecording() {
            console.log('‚èπÔ∏è Fermo registrazione');
            
            isRecording = false;

            if (mediaRecorder) {
                if (mediaRecorder.stream) {
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                }
                if (mediaRecorder.processor) {
                    mediaRecorder.processor.disconnect();
                }
                if (mediaRecorder.source) {
                    mediaRecorder.source.disconnect();
                }
            }

            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
            }

            mediaRecorder = null;

            startBtn.disabled = false;
            stopBtn.disabled = true;
            statusText.textContent = 'üü¢ Connesso al backend - Pronto!';

            console.log('‚úÖ Registrazione fermata');
        }

        // ==========================================
        // AUDIO PROCESSING
        // ==========================================
        function float32ToPCM16(float32Array) {
            const pcm16 = new Int16Array(float32Array.length);
            for (let i = 0; i < float32Array.length; i++) {
                const s = Math.max(-1, Math.min(1, float32Array[i]));
                pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
            }
            return pcm16;
        }

        // ==========================================
        // UI UPDATES
        // ==========================================
        function addTranscript(text) {
            if (transcriptBox.querySelector('.empty-state')) {
                transcriptBox.innerHTML = '';
            }

            transcripts++;
            transcriptCount.textContent = transcripts;

            const item = document.createElement('div');
            item.className = 'transcript-item';
            
            const time = new Date().toLocaleTimeString('it-IT');
            
            item.innerHTML = `
                <div class="transcript-time">${time}</div>
                <div class="transcript-text">${text}</div>
            `;

            transcriptBox.appendChild(item);
            transcriptBox.scrollTop = transcriptBox.scrollHeight;
        }

        function addSuggestion(text, category) {
            if (suggestionsBox.querySelector('.empty-state')) {
                suggestionsBox.innerHTML = '';
            }

            suggestions++;
            suggestionCount.textContent = suggestions;

            const item = document.createElement('div');
            item.className = 'suggestion-item';
            
            const categoryLabels = {
                'conversational': 'üéß Conversational',
                'value': 'üíé Value',
                'closing': '‚úÖ Closing',
                'market': 'üåê Market'
            };
            
            const categoryLabel = categoryLabels[category] || 'üí° Suggerimento';
            
            item.innerHTML = `
                <div class="suggestion-header">
                    <div class="suggestion-category">${categoryLabel}</div>
                    <div class="suggestion-badge">AI</div>
                </div>
                <div class="suggestion-text">${text}</div>
            `;

            suggestionsBox.insertBefore(item, suggestionsBox.firstChild);
        }

        function updateDuration() {
            if (!startTime) return;
            
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            durationEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        startBtn.addEventListener('click', () => {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                connectWebSocket();
                setTimeout(startRecording, 1000); // Aspetta connessione
            } else {
                startRecording();
            }
        });

        stopBtn.addEventListener('click', stopRecording);

        // ==========================================
        // PWA SERVICE WORKER
        // ==========================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('‚úÖ Service Worker registrato:', registration.scope))
                    .catch(err => console.log('‚ùå Service Worker registrazione fallita:', err));
            });
        }

        // ==========================================
        // INIT
        // ==========================================
        console.log('üöÄ SalesGenius PWA caricata');
        console.log('üì° Backend URL:', WS_URL);
        
        // Test connessione all'avvio
        console.log('üîç Verifico se il backend √® online...');
        fetch('https://salesgenius-backend.onrender.com/health')
            .then(res => res.json())
            .then(data => {
                console.log('‚úÖ Backend online:', data);
                statusText.textContent = 'üü¢ Backend online - Pronto per iniziare!';
            })
            .catch(err => {
                console.error('‚ùå Backend non raggiungibile:', err);
                console.warn('‚ö†Ô∏è Il backend su Render potrebbe essere in sleep. Prova a cliccare START e aspetta 30-60 secondi.');
                statusText.textContent = 'üü° Backend in sleep - Clicca START per svegliarlo';
            });
    </script>
</body>
</html>
